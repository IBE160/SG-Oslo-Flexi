# Brainstorming Session: Quiz Engine & Progress Tracking

**Date:** 2025-11-09
**Attendees:** Gemini, BMM Team

## Objective
To design the data models, API endpoints, and user flow for the quiz-taking and progress tracking functionality of AI Buddy.

---

### 1. Core User Experience

1.  **Start Quiz:** User selects a "Learning Pack" and clicks "Take Quiz".
2.  **Answering Questions:** The UI presents one multiple-choice question at a time. The user selects an answer and clicks "Submit".
3.  **Immediate Feedback:** The UI immediately indicates if the answer was correct or incorrect. The correct answer is highlighted. A brief explanation (generated by the Coach Agent) can be shown.
4.  **Progression:** The user moves to the next question. A progress bar shows `Question 3 of 10`.
5.  **Quiz Summary:** After the final question, a summary screen displays:
    -   Final Score (e.g., `7/10 - 70%`).
    -   Time taken.
    -   A list of incorrect answers with the correct options.
6.  **Feedback & Next Steps:** The "Coach Agent" provides targeted feedback, e.g., "You seem to be struggling with [Concept X]. Would you like to generate more questions on this topic?"

---

### 2. Data Models (PostgreSQL)

#### `quizzes` Table
This table stores the quiz structure generated by the Coach Agent.

| Column | Type | Description |
| --- | --- | --- |
| `id` | `UUID` | Primary Key. |
| `session_id` | `UUID` | Foreign Key to `sessions` table. Links the quiz to the source material. |
| `created_at` | `TIMESTAMPTZ` | When the quiz was generated. |
| `title` | `TEXT` | e.g., "Quiz for Introduction to Python". |

#### `quiz_questions` Table
Stores each individual question within a quiz.

| Column | Type | Description |
| --- | --- | --- |
| `id` | `UUID` | Primary Key. |
| `quiz_id` | `UUID` | Foreign Key to `quizzes` table. |
| `question_text` | `TEXT` | The question itself. |
| `options` | `JSONB` | An array of strings, e.g., `["Option A", "Option B", "Option C", "Option D"]`. |
| `correct_answer_index` | `INTEGER` | The 0-based index of the correct answer in the `options` array. |
| `explanation` | `TEXT` | (Optional) A brief explanation of the correct answer, generated by the Coach. |
| `related_concept` | `TEXT` | (Optional) The key concept this question relates to. Used for adaptive feedback. |

#### `quiz_attempts` Table
Tracks each time a user takes a quiz.

| Column | Type | Description |
| --- | --- | --- |
| `id` | `UUID` | Primary Key. |
| `quiz_id` | `UUID` | Foreign Key to `quizzes` table. |
| `user_id` | `UUID` | Foreign Key to `users` table. |
| `started_at` | `TIMESTAMPTZ` | When the user started the attempt. |
| `completed_at` | `TIMESTAMPTZ` | When the user finished the attempt. |
| `score` | `INTEGER` | The number of correct answers. |
| `total_questions` | `INTEGER` | The total number of questions in the quiz. |

#### `user_answers` Table
Stores the user's specific answer for each question in an attempt. This allows for detailed review.

| Column | Type | Description |
| --- | --- | --- |
| `id` | `UUID` | Primary Key. |
| `attempt_id` | `UUID` | Foreign Key to `quiz_attempts` table. |
| `question_id` | `UUID` | Foreign Key to `quiz_questions` table. |
| `selected_answer_index` | `INTEGER` | The index of the answer the user chose. |
| `is_correct` | `BOOLEAN` | Was the answer correct? (Derived on submission for quick lookups). |

---

### 3. API Endpoints (FastAPI)

#### 1. Get a Quiz
-   **Endpoint:** `GET /api/quizzes/{quiz_id}`
-   **Auth:** Required.
-   **Action:** Fetches the quiz and its questions (without the answers). The backend should shuffle the question order and option order for each attempt.
-   **Response:**
    ```json
    {
      "attemptId": "new-attempt-uuid",
      "quizTitle": "Quiz for Intro to Python",
      "questions": [
        {
          "questionId": "q-uuid-1",
          "questionText": "What is a list in Python?",
          "options": ["A mutable sequence", "An immutable sequence", "A type of hat", "A number"]
        },
        // ... more questions
      ]
    }
    ```

#### 2. Submit an Answer
-   **Endpoint:** `POST /api/quizzes/attempts/{attempt_id}/submit`
-   **Auth:** Required.
-   **Action:** The frontend sends the user's answer for a single question. The backend records it in `user_answers` and returns immediate feedback.
-   **Request Body:**
    ```json
    {
      "questionId": "q-uuid-1",
      "selectedAnswerIndex": 0
    }
    ```
-   **Response:**
    ```json
    {
      "isCorrect": true,
      "correctAnswerIndex": 0,
      "explanation": "A list is a mutable sequence, meaning its contents can be changed after creation."
    }
    ```

#### 3. Complete a Quiz
-   **Endpoint:** `POST /api/quizzes/attempts/{attempt_id}/complete`
-   **Auth:** Required.
-   **Action:** The frontend signals the end of the quiz. The backend calculates the final score, updates the `quiz_attempts` table, and returns the summary.
-   **Response:**
    ```json
    {
      "attemptId": "new-attempt-uuid",
      "score": 8,
      "totalQuestions": 10,
      "percentage": 80.0,
      "feedback": {
        "summary": "Great job! You have a good grasp of the basics. You missed a couple of questions related to 'Tuples'.",
        "weakAreas": ["Tuples"]
      }
    }
    ```

#### 4. Get Progress Overview
-   **Endpoint:** `GET /api/progress`
-   **Auth:** Required.
-   **Action:** Fetches aggregated progress data for the user's dashboard.
-   **Response:**
    ```json
    {
      "overallScore": 75.5, // Average score across all quizzes
      "quizzesCompleted": 12,
      "recentAttempts": [
        { "quizTitle": "Intro to Python", "score": 80, "completedAt": "2025-11-08T..." },
        { "quizTitle": "Data Structures", "score": 60, "completedAt": "2025-11-07T..." }
      ],
      "strengths": ["Lists", "Dictionaries"],
      "weaknesses": ["Tuples", "Recursion"] // Derived from incorrect answers
    }
    ```

---
### 4. Key Implementation Details

-   **Answer Shuffling:** To prevent users from memorizing the position of answers (`A`, `B`, `C`, `D`), the `options` array should be shuffled on the backend before being sent to the client. The `correctAnswerIndex` must, of course, refer to the index in the *shuffled* array for that specific attempt.
-   **Deriving Weaknesses:** The `weaknesses` in the progress overview can be calculated by running a query that groups incorrect answers by their `related_concept`. `SELECT related_concept, COUNT(*) FROM user_answers WHERE is_correct = false AND user_id = ? GROUP BY related_concept ORDER BY COUNT(*) DESC`.
-   **Coach Feedback:** The feedback after a quiz is a perfect opportunity for another agent call. The backend can send the list of `weakAreas` to the Coach Agent with a prompt like:
    > "A student just finished a quiz and struggled with these topics: [Tuples, Recursion]. Provide a short, encouraging message and ask if they'd like to generate a new, targeted quiz focusing on these areas."

---
### 5. Interoperability (Export/Import)

For portability, quizzes can be exported to standard Learning Management System (LMS) formats.

- **Mapping our Model to QTI:**
  - `quiz_questions` maps to an `<assessmentItem>`.
  - `question_text` maps to `<itemBody>`.
  - `options` map to `<simpleChoice>` elements within a `<choiceInteraction>`.
  - `correct_answer_index` maps to a `<responseDeclaration>` and `<correctResponse>`.

- **Mapping our Model to Moodle XML:**
  - The entire quiz maps to a `<quiz>` block.
  - Each question becomes a `<question type="multichoice">`.
  - `question_text` is placed in `<questiontext format="html">`.
  - Each option in `options` becomes an `<answer>` tag with a `fraction` attribute (100 for correct, 0 for incorrect).

#### Minimal QTI v2.1 Example (for one MCQ)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<assessmentItem xmlns="http://www.imsglobal.org/xsd/imsqti_v2p1"
  identifier="q1" title="Python Lists" adaptive="false" timeDependent="false">
  <responseDeclaration identifier="RESPONSE" cardinality="single" baseType="identifier">
    <correctResponse>
      <value>choice_a</value>
    </correctResponse>
  </responseDeclaration>
  <itemBody>
    <p>What is a list in Python?</p>
    <choiceInteraction responseIdentifier="RESPONSE" shuffle="true" maxChoices="1">
      <simpleChoice identifier="choice_a">A mutable sequence</simpleChoice>
      <simpleChoice identifier="choice_b">An immutable sequence</simpleChoice>
      <simpleChoice identifier="choice_c">A type of hat</simpleChoice>
      <simpleChoice identifier="choice_d">A number</simpleChoice>
    </choiceInteraction>
  </itemBody>
</assessmentItem>
```

#### Minimal Moodle XML Example (for one MCQ)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<quiz>
  <question type="multichoice">
    <name>
      <text>Python Lists</text>
    </name>
    <questiontext format="html">
      <![CDATA[<p>What is a list in Python?</p>]]>
    </questiontext>
    <answer fraction="100">
      <text>A mutable sequence</text>
    </answer>
    <answer fraction="0">
      <text>An immutable sequence</text>
    </answer>
    <answer fraction="0">
      <text>A type of hat</text>
    </answer>
    <answer fraction="0">
      <text>A number</text>
    </answer>
  </question>
</quiz>
```

- **Validation**: Exported files should be validated against the official XSD schemas for QTI and Moodle XML to ensure compatibility.
- **Non-Goals (MVP)**:
  - Importing quizzes from these formats.
  - Supporting advanced QTI features like adaptive testing, templates, or complex response processing.
  - Exporting question types other than multiple-choice.